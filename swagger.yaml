openapi: 3.0.0
info:
  title: API Finanzas - Chat, Usuarios y Seguridad
  version: 1.0.0
  description: Documentación de la API creada en Sinatra para el manejo de usuarios, chat, seguridad y perfil.

servers:
  - url: http://localhost:4567

paths:

  ############################################
  # PAGOS PLANIFICADOS - CATÁLOGOS
  ############################################
  /pagos-planificados/catalogos:
    get:
      tags: [Planificacion]
      summary: Obtener todas las listas de selección (Frecuencias, Categorías, Cuentas)
      parameters:
        - in: query
          name: user_id
          required: true
          schema:
            type: integer
            description: ID del usuario para filtrar sus cuentas
      responses:
        '200':
          description: Catálogos obtenidos correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogosResponse'


  ############################################
  # PAGOS PLANIFICADOS
  ############################################
  /pagos-planificados:
    get:
      tags: [Planificacion]
      summary: Listar pagos planificados del usuario
      parameters:
        - in: query
          name: user_id
          required: true
          schema:
            type: integer
            description: ID del usuario para filtrar sus pagos
      responses:
        '200':
          description: Pagos obtenidos correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagoPlanificadoListResponse'

    post:
      tags: [Planificacion]
      summary: Crear nuevo pago planificado
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PagoPlanificadoCreateRequest'
      responses:
        '201':
          description: Pago planificado creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagoPlanificadoCreateResponse'
        '400':
          description: Datos faltantes o inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pagos-planificados/{id}:
    put:
      tags: [Planificacion]
      summary: Actualizar pago planificado existente
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PagoPlanificadoCreateRequest'
      responses:
        '200':
          description: Pago planificado actualizado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagoPlanificadoCreateResponse'
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Pago planificado no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags: [Planificacion]
      summary: Eliminar un pago planificado
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: query
          name: user_id
          required: true
          schema:
            type: integer
            description: ID del usuario para verificar propiedad
      responses:
        '200':
          description: Pago eliminado
        '404':
          description: Pago no encontrado
  


  ############################################
  # LOGIN
  ############################################
  /login:
    post:
      summary: Iniciar sesión
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Inicio de sesión exitoso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciales inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  ############################################
  # REGISTRO
  ############################################
  /registro:
    post:
      summary: Registrar usuario
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegistroRequest'
      responses:
        '201':
          description: Usuario creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistroResponse'
        '409':
          description: Correo ya registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  ############################################
  # PERFIL
  ############################################
  /perfil/{id}:
    get:
      summary: Obtener perfil por ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Perfil obtenido correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerfilResponse'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: Actualizar perfil
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PerfilUpdateRequest'
      responses:
        '200':
          description: Perfil actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerfilResponse'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /perfil/{id}/imagen:
    put:
      summary: Subir o actualizar imagen de perfil
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                imagen:
                  type: string
                  format: binary
      responses:
        '200':
          description: Imagen actualizada correctamente

  ############################################
  # CHAT
  ############################################
  /chat:
    post:
      summary: Enviar mensaje y recibir respuesta automática
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Respuesta generada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'

  /chat/{id_usuario}:
    get:
      summary: Obtener historial del chat de un usuario
      parameters:
        - in: path
          name: id_usuario
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Historial del chat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatHistoryResponse'
        '404':
          description: No hay mensajes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  ############################################
  # ELIMINAR CUENTA
  ############################################
  /cuenta/{id}:
    delete:
      summary: Eliminar cuenta de usuario
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteAccountRequest'
      responses:
        '200':
          description: Cuenta eliminada correctamente
        '404':
          description: Usuario no encontrado

  ############################################
  # RESET PASSWORD
  ############################################
  /reset_password:
    post:
      summary: Solicitar restablecimiento de contraseña
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Correo enviado

  ############################################
  # TWO FACTOR
  ############################################
  /two_factor/send_code:
    post:
      summary: Enviar código de verificación
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TwoFactorRequest'
      responses:
        '200':
          description: Código enviado

components:
  schemas:

    ############################################
    # AUTENTICACIÓN
    ############################################
    LoginRequest:
      type: object
      properties:
        correo: { type: string }
        contraseña: { type: string }
      required: [correo, contraseña]

    LoginResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }
        usuario:
          $ref: '#/components/schemas/Usuario'

    RegistroRequest:
      type: object
      properties:
        nombres: { type: string }
        apellidos: { type: string }
        correo: { type: string }
        contraseña: { type: string }
      required: [nombres, apellidos, correo, contraseña]

    RegistroResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }
        usuario:
          $ref: '#/components/schemas/Usuario'

    ############################################
    # PERFIL
    ############################################
    PerfilUpdateRequest:
      type: object
      properties:
        nombres: { type: string }
        apellidos: { type: string }
        correo: { type: string }
        contraseña: { type: string }

    PerfilResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }
        usuario:
          $ref: '#/components/schemas/Usuario'

    ############################################
    # CHAT
    ############################################
    ChatRequest:
      type: object
      properties:
        mensaje: { type: string }
        idUsuario: { type: integer }
      required: [mensaje, idUsuario]

    ChatResponse:
      type: object
      properties:
        status: { type: string }
        respuesta: { type: string }

    ChatHistoryResponse:
      type: object
      properties:
        status: { type: string }
        historial:
          type: array
          items:
            $ref: '#/components/schemas/MensajeChat'

    ############################################
    # UTIL
    ############################################
    Usuario:
      type: object
      properties:
        id: { type: integer }
        nombres: { type: string }
        apellidos: { type: string }
        correo: { type: string }
        imagen_perfil: { type: string }

    MensajeChat:
      type: object
      properties:
        id: { type: integer }
        id_usuario: { type: integer }
        texto: { type: string }
        fecha: { type: string }

    DeleteAccountRequest:
      type: object
      properties:
        confirm_password: { type: string }

    ResetPasswordRequest:
      type: object
      properties:
        correo: { type: string }

    TwoFactorRequest:
      type: object
      properties:
        correo: { type: string }

    ErrorResponse:
      type: object
      properties:
        status: { type: string }
        message: { type: string }
        detalle: { type: string }

    #######################################
    # PAGOS PLANIFICADOS
    #######################################
    CatalogoItem:
      type: object
      properties:
        id: { type: integer, description: ID interno de la tabla de catálogo. }
        nombre: { type: string, description: Nombre a mostrar en el frontend. }
      required: [id, nombre]

    CuentaItem:
      type: object
      properties:
        id: { type: integer }
        nombre: { type: string }
        saldo: { type: number, format: float }
        idMoneda: { type: integer }

    CatalogosResponse:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
        data:
          type: object
          properties:
            tipos_transaccion: { type: array, description: Lista de Ingreso/Gasto., items: { $ref: '#/components/schemas/CatalogoItem' } }
            frecuencias: { type: array, description: Lista de períodos (Mensual, Anual)., items: { $ref: '#/components/schemas/CatalogoItem' } }
            categorias: { type: array, description: Lista de categorías definidas por el usuario., items: { $ref: '#/components/schemas/CatalogoItem' } }
            tipos_pago: { type: array, description: Lista de tipos de pago., items: { $ref: '#/components/schemas/CatalogoItem' } }
            cuentas: { type: array, description: Cuentas del usuario., items: { $ref: '#/components/schemas/CuentaItem' } }
        error: { nullable: true }

    PagoPlanificadoItem:
      type: object
      properties:
        id: { type: integer }
        nombre: { type: string }
        monto: { type: number, format: float }
        tipo: { type: string, enum: [ingreso, gasto] }
        periodo: { type: string, description: Frecuencia (ej. Mensual). }
        categoria: { type: string, description: Nombre de la categoría. }
        proximaFecha: { type: string, format: date, description: Fecha del siguiente pago. }
      required: [id, nombre, monto, tipo, periodo, proximaFecha]

    PagoPlanificadoListResponse:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
        data:
          type: array
          items:
            $ref: '#/components/schemas/PagoPlanificadoItem'
        error: { nullable: true }

    PagoPlanificadoCreateRequest:
      type: object
      properties:
        nombre: { type: string }
        monto: { type: number, format: float }
        tipo: { type: string, description: 'ingreso o gasto' }
        periodo: { type: string, description: Nombre de la frecuencia (ej. Mensual). }
        categoria: { type: string, description: Nombre de la categoría (ej. Suscripciones). }
        id_cuenta: { type: integer, description: ID de la cuenta donde se aplicará el pago. }
        tipo_pago: { type: string, description: Nombre del TipoPago. }
        # Campos de recurrencia avanzada (opcionales)
        fecha_inicio: { type: string, format: date, description: Fecha del primer pago. }
        intervalo: { type: integer, default: 1 }
        fin_tipo: { type: string, enum: [NUNCA, FECHA, CONTEO], default: NUNCA }
        idUsuario: { type: integer, description: ID del usuario propietario del pago. }
      required: [nombre, monto, tipo, periodo, categoria, id_cuenta, tipo_pago, idUsuario]

    PagoPlanificadoCreateResponse:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
        data: { type: object, properties: { id: { type: integer, description: ID del pago planificado creado. } } }
        error: { nullable: true }